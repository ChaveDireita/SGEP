@model IEnumerable<SGEP.Models.Projeto>

@{
    ViewData["Title"] = "Index";
    ViewData["search-fields"] = "_Projeto";
}
<br />
<h2>Projetos</h2>
<br />
@await Html.PartialAsync("Partial/Index/Button/_CRUD")
<div class="float-right d-inline">
    @await Html.PartialAsync("Partial/Index/Button/_SearchButtons")
</div>
<br/>
<div class="container row justify-content-center">
    @await Html.PartialAsync("Partial/Index/Search/_Search", null, ViewData)
</div>
<br/>
<table class="table">
    <thead class="thead-dark">
        <tr>
            <th>
                @Html.DisplayNameFor(model => model.Id)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.Nome)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.Inicio)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.Fim)
            </th>
        </tr>
    </thead>
    </tbody>
</table>

@section Scripts 
{
    <script>

        const lista = document.getElementById('lista');
        const controller = 'ProjetoApi';

        list({});

        function list(searchParams)
        {
            refreshTable(controller, searchParams, ['id', 'nome', 'inicio', 'fim'], ({size}) => pagination.size = size);
        }

        function onClickSelectRow (id)
        {
            selectRow(id, () => 
            {
                //Código do modal
            },
            () => 
            {
                //Código do modal
            });
        }
    
        function showdetailsmodal(id) {
            atualizaralocacao(id);
            fetch('/Projeto/ProjetoSelecionado/?id=' + id).then((res) => res.json()).then(proj => {
                var detailstable = document.getElementById('detailstable');
                var nomes = ['ID', 'Nome', 'Início', 'Fim'];
                detailstable.innerHTML = gerardetailslist(nomes, proj);
            });
            document.getElementById('abriralocacao').onclick = function () {
                gerartabelas(id);
                $('#alocacaomodal').modal('toggle');
                $('#detailsmodal').modal('toggle');
            }
            $('#detailsmodal').modal('toggle');
        }
        //script pra atualizar a tabela de alocação sempre que precisar
        function atualizaralocacao(id) {
            fetch('/Projeto/FuncionarioNomes').then((res) => res.json()).then(nomes => {
                fetch('/Projeto/FuncionariosAlocados/?id=' + id).then((res) => res.json()).then(lista => {
                    var tabela = document.getElementById('tableidd');
                    tabela.innerHTML = gerarlist(nomes, lista);
                });
            });
        }
        
        var alocadostab = document.getElementById('tabelaalocados');
        var nalocadostab = document.getElementById('tabelanaoalocados');
        function gerartabelas(id) {
            fetch('/Projeto/FuncionarioNomes').then((res) => res.json()).then(nomes => {
                fetch('/Projeto/FuncionariosAlocados/?id=' + id).then((res) => res.json()).then(func => {
                    alocadostab.innerHTML = gerarlist(nomes, func, 'desalocar', id);
                });
                fetch('/Projeto/FuncionariosNaoAlocados/?id=' + id).then((res) => res.json()).then(func => {
                    nalocadostab.innerHTML = gerarlist(nomes, func, 'alocar', id);
                });
            });
        }
        function alocar(funid, projid) {
            const data = new FormData();
            data.append('IdFuncionario', funid);
            data.append('IdProjeto', projid);
            fetch('/Projeto/AlocarFuncionario', { method: 'POST', body: data }).then(retorno => {
                gerartabelas(projid);
            });
            atualizaralocacao(projid);
        }
        function desalocar(funid, projid) {
            fetch('/Projeto/DesalocarProjeto?idfunc=' + funid + '&idproj=' + projid, { method: 'POST' }).then(retorno => {
                gerartabelas(projid);
            });
            atualizaralocacao(projid);
        }
        function alocardismiss() {
            $('#alocacaomodal').modal('toggle');
            $('#detailsmodal').modal('toggle');
        }
    </script>
}
<!--MODAL DE DETALHES-->
<div class="modal fade" id="detailsmodal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content squareborder">
            <div class="modal-header header-dark squareborder">
                <h5 class="modal-title" id="modaltitle">Detalhes do Projeto</h5>
                <button type="button" style="color:white;" class="close" data-dismiss="modal" aria-label="Fechar">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="modalbodyr">
                <h4>Informações:</h4>
                <table class="table table-bordered shadow-regular" id="detailstable"></table>
                <h4>Funcionários Associados:</h4>
                <table class="table" id="tableidd"></table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary squareborder" data-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary squareborder" id="abriralocacao">Editar Alocações</button>
            </div>
        </div>
    </div>
</div>

<!--MODAL DE ALOCAÇÃO-->

<div class="modal fade" id="alocacaomodal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content squareborder">
            <div class="modal-header header-dark squareborder">
                <h5 class="modal-title">Alocação</h5>
                <button type="button" style="color:white;" class="close" onclick="alocardismiss()" aria-label="Fechar">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="modalbody">
                <h5 class="modal-title" style="float: left;">Funcionários alocados:</h5>
                <h5 class="modal-title" style="float: right;">Funcionários não alocados:</h5>
                <br />
                <table class="table table-bordered shadow-regular" style="float: left; width: 45%" id="tabelaalocados"></table>
                <table class="table table-bordered shadow-regular" style="float: right; width: 45%" id="tabelanaoalocados"></table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary squareborder" onclick="alocardismiss()">Fechar</button>
            </div>
        </div>
    </div>
</div>
